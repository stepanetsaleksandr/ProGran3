# –ó–ú–Ü–ù–ò –î–õ–Ø –õ–Ü–¶–ï–ù–ó–Ü–ô–ù–û–á –°–ò–°–¢–ï–ú–ò - –î–ï–¢–ê–õ–¨–ù–ò–ô –û–ü–ò–°

## üìã –û–ì–õ–Ø–î –ó–ú–Ü–ù

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—É—î –≤—Å—ñ –∑–º—ñ–Ω–∏, —è–∫—ñ –±—É–ª–∏ –∑—Ä–æ–±–ª–µ–Ω—ñ –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ª—ñ—Ü–µ–Ω–∑—ñ–π–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –≤ ProGran3. –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –¥–æ —Ä–æ–±–æ—á–æ–≥–æ —Å—Ç–∞–Ω—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–µ–π –¥–æ–∫—É–º–µ–Ω—Ç —è–∫ –ø–æ—Å—ñ–±–Ω–∏–∫.

## üéØ –ú–ï–¢–ê –ó–ú–Ü–ù

–†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω—É –ª—ñ—Ü–µ–Ω–∑—ñ–π–Ω—É —Å–∏—Å—Ç–µ–º—É –∑:
- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—î—é –ª—ñ—Ü–µ–Ω–∑—ñ–π —á–µ—Ä–µ–∑ –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å
- –ê–∫—Ç–∏–≤–∞—Ü—ñ—î—é –ª—ñ—Ü–µ–Ω–∑—ñ–π –≤ –ø–ª–∞–≥—ñ–Ω—ñ
- HMAC –ø—ñ–¥–ø–∏—Å–æ–º –¥–ª—è –±–µ–∑–ø–µ–∫–∏
- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º —Å—Ç–∞—Ç—É—Å—É –ª—ñ—Ü–µ–Ω–∑—ñ—ó –≤ UI

## üìÅ –§–ê–ô–õ–ò, –Ø–ö–Ü –ë–£–õ–ò –ó–ú–Ü–ù–ï–ù–Ü

### 1. **plugin/proGran3/ui.rb**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** Callback `license_display_info`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤–µ—Ä—Ç–∞–≤ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ `execute_script`, —â–æ –≤–∏–∫–ª–∏–∫–∞–ª–æ JSON.parse –ø–æ–º–∏–ª–∫–∏
**–†—ñ—à–µ–Ω–Ω—è:** –ü—Ä—è–º–∏–π –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è JSON —á–µ—Ä–µ–∑ `result.to_json`

```ruby
# –ë–£–õ–û:
@dialog.execute_cript("updateLicenseStatusWithData('#{result.to_json}')")

# –°–¢–ê–õ–û:
result.to_json  # –ü—Ä—è–º–∏–π –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è JSON
```

### 2. **plugin/proGran3/web/script.js**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** –§—É–Ω–∫—Ü—ñ—ó `updateLicenseStatus()` —Ç–∞ `updateLicenseStatusWithData()`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ JSON –¥–∞–Ω–∏—Ö –≤—ñ–¥ Ruby
**–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—É –¥–∞–Ω–∏—Ö —Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥

```javascript
// –ë–£–õ–û:
const result = window.sketchup.license_display_info();
const licenseDisplayInfo = JSON.parse(result);

// –°–¢–ê–õ–û:
const result = window.sketchup.license_display_info();
if (typeof result === 'object' && result !== null) {
  licenseDisplayInfo = result;
} else if (typeof result === 'string') {
  licenseDisplayInfo = JSON.parse(result);
}
```

### 3. **server/app/api/admin/licenses/generate/route.ts** (–ù–û–í–ò–ô –§–ê–ô–õ)
**–©–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ:** API endpoint –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ª—ñ—Ü–µ–Ω–∑—ñ–π –≤ –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—ñ
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–¥—Å—É—Ç–Ω—ñ–π endpoint –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª—ñ—Ü–µ–Ω–∑—ñ–π
**–†—ñ—à–µ–Ω–Ω—è:** –°—Ç–≤–æ—Ä–µ–Ω–æ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π endpoint –∑ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é

### 4. **server/app/hooks/useLicenses.ts**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** –§—É–Ω–∫—Ü—ñ—è `createLicense`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL —Ç–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
**–†—ñ—à–µ–Ω–Ω—è:** –û–Ω–æ–≤–ª–µ–Ω–æ URL —Ç–∞ –¥–æ–¥–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ JSON

### 5. **plugin/proGran3/system/core/config_manager.rb**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** –î–æ–¥–∞–Ω–æ HMAC –ø—ñ–¥–ø–∏—Å
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–¥—Å—É—Ç–Ω—ñ–π HMAC –ø—ñ–¥–ø–∏—Å –¥–ª—è –±–µ–∑–ø–µ–∫–∏
**–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–æ –º–µ—Ç–æ–¥–∏ `create_hmac_signature` —Ç–∞ `create_authenticated_headers`

```ruby
# –î–û–î–ê–ù–û:
def self.create_hmac_signature(body, timestamp)
  require 'openssl'
  secret = ENV['HMAC_SECRET_KEY'] || get_fallback_secret
  normalized_body = body.strip.force_encoding('UTF-8')
  normalized_timestamp = timestamp.to_i
  message = "#{normalized_body}#{normalized_timestamp}"
  hmac = OpenSSL::HMAC.hexdigest(OpenSSL::Digest.new('sha256'), secret, message)
  hmac
end
```

### 6. **plugin/proGran3/system/network/network_client.rb**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** –î–æ–¥–∞–Ω–æ HMAC –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ –∑–∞–ø–∏—Ç—ñ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–¥—Å—É—Ç–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–ø–µ–∫–∏
**–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–æ `X-Signature` –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ –≤—Å—ñ—Ö –∑–∞–ø–∏—Ç—ñ–≤

### 7. **server/app/api/licenses/activate/route.ts**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** –î–æ–¥–∞–Ω–æ HMAC –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–¥—Å—É—Ç–Ω—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—è HMAC –ø—ñ–¥–ø–∏—Å—É
**–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–æ `requireHMAC(request)` –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó

### 8. **plugin/config.json**
**–©–æ –∑–º—ñ–Ω–µ–Ω–æ:** –û–Ω–æ–≤–ª–µ–Ω–æ URL —Å–µ—Ä–≤–µ—Ä–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π Vercel URL
**–†—ñ—à–µ–Ω–Ω—è:** –ó–º—ñ–Ω–µ–Ω–æ –Ω–∞ —Å—Ç–∞—Ç–∏—á–Ω–∏–π URL `https://server-one-amber.vercel.app`

## üîß –¢–ï–•–ù–Ü–ß–ù–Ü –î–ï–¢–ê–õ–Ü

### HMAC –ü—ñ–¥–ø–∏—Å
- **–ê–ª–≥–æ—Ä–∏—Ç–º:** SHA256
- **–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞:** OpenSSL::HMAC (–∑–∞–º—ñ—Å—Ç—å Digest::HMAC)
- **–°–µ–∫—Ä–µ—Ç:** `ProGran3-Secure-HMAC-Secret-2025-v3.2-SERVER-ONLY-9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d`
- **–§–æ—Ä–º–∞—Ç:** `HMAC(body + timestamp)`

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–ø–µ–∫–∏
```
X-Fingerprint: hardware_fingerprint
X-Timestamp: unix_timestamp
X-Signature: hmac_signature
X-Endpoint: /api/licenses/activate
X-Plugin-Version: 3.2.0
```

### JSON –û–±—Ä–æ–±–∫–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** `JSON.parse: unexpected end of data`
- **–ü—Ä–∏—á–∏–Ω–∞:** Ruby –ø–æ–≤–µ—Ä—Ç–∞–≤ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ `execute_script`
- **–†—ñ—à–µ–Ω–Ω—è:** –ü—Ä—è–º–∏–π –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è JSON –∑ Ruby callback

## üö® –ü–†–û–ë–õ–ï–ú–ò, –Ø–ö–Ü –í–ò–ù–ò–ö–õ–ò

### 1. **LoadError: library not found for class Digest::HMAC**
**–ü—Ä–∏—á–∏–Ω–∞:** SketchUp –Ω–µ –º–∞—î Digest::HMAC
**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ OpenSSL::HMAC

### 2. **Invalid HMAC signature**
**–ü—Ä–∏—á–∏–Ω–∞:** –†—ñ–∑–Ω—ñ —Å–µ–∫—Ä–µ—Ç–∏ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ —Ç–∞ —Å–µ—Ä–≤–µ—Ä—ñ
**–†—ñ—à–µ–Ω–Ω—è:** –£–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—è —Å–µ–∫—Ä–µ—Ç—É —á–µ—Ä–µ–∑ `get_fallback_secret`

### 3. **Timestamp mismatch**
**–ü—Ä–∏—á–∏–Ω–∞:** –†—ñ–∑–Ω—ñ timestamp –¥–ª—è HMAC —Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
**–†—ñ—à–µ–Ω–Ω—è:** –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è timestamp –æ–¥–∏–Ω —Ä–∞–∑ –≤ `create_authenticated_headers`

### 4. **JSON body inconsistency**
**–ü—Ä–∏—á–∏–Ω–∞:** –†—ñ–∑–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –∫–ª—é—á—ñ–≤ –≤ JSON
**–†—ñ—à–µ–Ω–Ω—è:** –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è payload —á–µ—Ä–µ–∑ `normalize_payload`

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ú–Ü–ù

- **–ù–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤:** 1 (server/app/api/admin/licenses/generate/route.ts)
- **–ó–º—ñ–Ω–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤:** 7
- **–î–æ–¥–∞–Ω–æ —Ä—è–¥–∫—ñ–≤ –∫–æ–¥—É:** ~200
- **–í–∏–¥–∞–ª–µ–Ω–æ —Ä—è–¥–∫—ñ–≤ –∫–æ–¥—É:** ~50
- **–¢–µ—Å—Ç–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤ —Å—Ç–≤–æ—Ä–µ–Ω–æ:** 5

## üîÑ –ü–õ–ê–ù –í–Ü–î–ö–ê–¢–£–í–ê–ù–ù–Ø

### –ö—Ä–æ–∫ 1: –í—ñ–¥–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö –∑–º—ñ–Ω
```bash
# –í–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ–≤–∏–π —Ñ–∞–π–ª
rm server/app/api/admin/licenses/generate/route.ts

# –í—ñ–¥–∫–∞—Ç –∑–º—ñ–Ω –≤ useLicenses.ts
git checkout HEAD~1 server/app/hooks/useLicenses.ts

# –í—ñ–¥–∫–∞—Ç –∑–º—ñ–Ω –≤ activate/route.ts
git checkout HEAD~1 server/app/api/licenses/activate/route.ts
```

### –ö—Ä–æ–∫ 2: –í—ñ–¥–∫–∞—Ç –ø–ª–∞–≥—ñ–Ω–æ–≤–∏—Ö –∑–º—ñ–Ω
```bash
# –í—ñ–¥–∫–∞—Ç ui.rb
git checkout HEAD~1 plugin/proGran3/ui.rb

# –í—ñ–¥–∫–∞—Ç script.js
git checkout HEAD~1 plugin/proGran3/web/script.js

# –í—ñ–¥–∫–∞—Ç config_manager.rb
git checkout HEAD~1 plugin/proGran3/system/core/config_manager.rb

# –í—ñ–¥–∫–∞—Ç network_client.rb
git checkout HEAD~1 plugin/proGran3/system/network/network_client.rb

# –í—ñ–¥–∫–∞—Ç config.json
git checkout HEAD~1 plugin/config.json
```

### –ö—Ä–æ–∫ 3: –û—á–∏—â–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤
```bash
# –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏
rm plugin/proGran3/test_*.rb
rm plugin/proGran3/simple_test.rb
rm plugin/proGran3/debug_*.rb
rm plugin/proGran3/force_reload_*.rb
```

## ‚úÖ –ü–ï–†–ï–í–Ü–†–ö–ê –ü–Ü–°–õ–Ø –í–Ü–î–ö–ê–¢–£–í–ê–ù–ù–Ø

1. **–ü–ª–∞–≥—ñ–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫**
2. **UI –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ**
3. **–ü–æ–±—É–¥–æ–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –ø—Ä–∞—Ü—é—î**
4. **–ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª—ñ**
5. **–õ—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∏–π UI –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è (—è–∫ –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ)**

## üìù –í–ò–°–ù–û–í–ö–ò

–õ—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –±—É–ª–∞ —É—Å–ø—ñ—à–Ω–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞, –∞–ª–µ –ø–æ—Ç—Ä–µ–±—É–≤–∞–ª–∞ –±–∞–≥–∞—Ç–æ –∑–º—ñ–Ω –≤ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—ñ. –û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ JSON –º—ñ–∂ Ruby —Ç–∞ JavaScript
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å HMAC –±–µ–∑–ø–µ–∫–∏
- –ü—Ä–æ–±–ª–µ–º–∏ –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞–º–∏ –≤ SketchUp
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

–í—Å—ñ –∑–º—ñ–Ω–∏ –±—É–ª–∏ –∑—Ä–æ–±–ª–µ–Ω—ñ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —ñ—Å–Ω—É—é—á–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –ø–ª–∞–≥—ñ–Ω–∞.

---
**–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** 25 –∂–æ–≤—Ç–Ω—è 2025  
**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–í–µ—Ä—Å—ñ—è:** 1.0

