<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGran3 - –¢–µ—Å—Ç –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ pending</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ccc;
        }
        .test-result.pass {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        .test-result.fail {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        .test-result.info {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
        }
        .test-result.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        .pending-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç –¢–µ—Å—Ç –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ pending –¥–∞–Ω–∏—Ö</h1>
        <p>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–∫—Ä–∞—â–µ–Ω—å –≤ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—Ü—ñ —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—ñ pending –¥–∞–Ω–∏—Ö</p>
        
        <div id="test-results"></div>
        
        <div id="pending-info" class="pending-info">
            <strong>Pending –¥–∞–Ω—ñ:</strong> <span id="pending-count">0</span><br>
            <strong>–î–µ—Ç–∞–ª—ñ:</strong> <span id="pending-details">–ù–µ–º–∞—î</span>
        </div>
        
        <button onclick="runTests()" style="
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        ">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç–∏</button>
        
        <button onclick="cleanupPending()" style="
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            margin-left: 10px;
        ">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ pending</button>
    </div>

    <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –º–æ–¥—É–ª—ñ -->
    <script src="modules/core/Config.js"></script>
    <script src="modules/core/Logger.js"></script>
    <script src="modules/core/StateManager.js"></script>
    <script src="modules/utils/Helpers.js"></script>
    <script src="modules/utils/Validation.js"></script>
    <script src="modules/utils/Units.js"></script>
    <script src="modules/communication/SketchUpBridge.js"></script>
    <script src="modules/ui/Tabs.js"></script>
    <script src="modules/ui/Panels.js"></script>
    <script src="modules/ui/SummaryTable.js"></script>
    <script src="modules/builders/FoundationBuilder.js"></script>

    <script>
        function addTestResult(message, type = 'info') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function updatePendingInfo() {
            if (window.ProGran3 && window.ProGran3.Communication && window.ProGran3.Communication.SketchUpBridge) {
                const status = window.ProGran3.Communication.SketchUpBridge.getConnectionStatus();
                document.getElementById('pending-count').textContent = status.pendingPreviews;
                
                // –û—Ç—Ä–∏–º—É—î–º–æ –¥–µ—Ç–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ pending
                const bridge = window.ProGran3.Communication.SketchUpBridge;
                if (bridge._pendingPreviews) {
                    const details = Object.keys(bridge._pendingPreviews).join(', ');
                    document.getElementById('pending-details').textContent = details || '–ù–µ–º–∞—î';
                } else {
                    document.getElementById('pending-details').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                }
            }
        }

        function cleanupPending() {
            if (window.ProGran3 && window.ProGran3.Communication && window.ProGran3.Communication.SketchUpBridge) {
                window.ProGran3.Communication.SketchUpBridge.cleanupOldPendingPreviews();
                updatePendingInfo();
                addTestResult('üßπ –í–∏–∫–ª–∏–∫–∞–Ω–æ –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö pending –∑–∞–ø–∏—Å—ñ–≤', 'info');
            }
        }

        function runTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '';
            
            addTestResult('üöÄ –ü–æ—á–∞—Ç–æ–∫ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ pending...', 'info');
            
            try {
                // –¢–µ—Å—Ç 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–¥—É–ª—ñ–≤
                if (window.ProGran3 && window.ProGran3.Communication && window.ProGran3.Communication.SketchUpBridge) {
                    addTestResult('‚úÖ SketchUpBridge –º–æ–¥—É–ª—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', 'pass');
                } else {
                    addTestResult('‚ùå SketchUpBridge –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', 'fail');
                    return;
                }
                
                // –¢–µ—Å—Ç 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
                const bridge = window.ProGran3.Communication.SketchUpBridge;
                
                if (typeof bridge.cleanupOldPendingPreviews === 'function') {
                    addTestResult('‚úÖ cleanupOldPendingPreviews —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞', 'pass');
                } else {
                    addTestResult('‚ùå cleanupOldPendingPreviews —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'fail');
                }
                
                if (typeof bridge.getConnectionStatus === 'function') {
                    addTestResult('‚úÖ getConnectionStatus —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞', 'pass');
                } else {
                    addTestResult('‚ùå getConnectionStatus —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'fail');
                }
                
                // –¢–µ—Å—Ç 3: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è getConnectionStatus
                try {
                    const status = bridge.getConnectionStatus();
                    addTestResult(`‚úÖ getConnectionStatus –ø–æ–≤–µ—Ä—Ç–∞—î: ${JSON.stringify(status)}`, 'pass');
                } catch (error) {
                    addTestResult(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ getConnectionStatus: ${error.message}`, 'fail');
                }
                
                // –¢–µ—Å—Ç 4: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è cleanupOldPendingPreviews
                try {
                    bridge.cleanupOldPendingPreviews();
                    addTestResult('‚úÖ cleanupOldPendingPreviews –ø—Ä–∞—Ü—é—î –±–µ–∑ –ø–æ–º–∏–ª–æ–∫', 'pass');
                } catch (error) {
                    addTestResult(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ cleanupOldPendingPreviews: ${error.message}`, 'fail');
                }
                
                // –¢–µ—Å—Ç 5: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è pending –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º
                try {
                    const testItem = document.createElement('div');
                    testItem.className = 'test-item';
                    const testLoadingDiv = document.createElement('div');
                    testLoadingDiv.className = 'loading-indicator';
                    testItem.appendChild(testLoadingDiv);
                    
                    bridge.addPendingPreview('test/debug.skp', 'debug.skp', 'Test', testItem, testLoadingDiv);
                    addTestResult('‚úÖ addPendingPreview –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º –ø—Ä–∞—Ü—é—î', 'pass');
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ pending –¥–æ–¥–∞–Ω–æ
                    const statusAfter = bridge.getConnectionStatus();
                    if (statusAfter.pendingPreviews > 0) {
                        addTestResult(`‚úÖ Pending –¥–æ–¥–∞–Ω–æ: ${statusAfter.pendingPreviews} –∑–∞–ø–∏—Å—ñ–≤`, 'pass');
                    } else {
                        addTestResult('‚ö†Ô∏è Pending –Ω–µ –¥–æ–¥–∞–Ω–æ', 'warning');
                    }
                    
                } catch (error) {
                    addTestResult(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—ñ addPendingPreview: ${error.message}`, 'fail');
                }
                
                // –¢–µ—Å—Ç 6: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è receiveWebPreview –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º
                try {
                    const validBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                    bridge.receiveWebPreview('test/debug.skp', validBase64);
                    addTestResult('‚úÖ receiveWebPreview –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º –ª–æ–≥—É–≤–∞–Ω–Ω—è–º –ø—Ä–∞—Ü—é—î', 'pass');
                } catch (error) {
                    addTestResult(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—ñ receiveWebPreview: ${error.message}`, 'fail');
                }
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ pending
                updatePendingInfo();
                
                addTestResult('üèÅ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ pending –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'info');
                addTestResult('‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–∞—Ü—é—é—Ç—å!', 'pass');
                
            } catch (error) {
                addTestResult(`‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ —Ç–µ—Å—Ç—ñ: ${error.message}`, 'fail');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.addEventListener('load', () => {
            setTimeout(() => {
                runTests();
                updatePendingInfo();
            }, 500);
        });
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ pending –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
        setInterval(updatePendingInfo, 2000);
    </script>
</body>
</html>
